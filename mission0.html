<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>North Pole Intelligence Agency – Priority One Alert</title>
<link rel="stylesheet" href="transmission-style.css">
<style>
@keyframes screenFlicker {
  0%, 18%, 22%, 25%, 53%, 57%, 100% { opacity: 1; }
  20%, 24%, 55% { opacity: 0; }
}
.flicker { animation: screenFlicker 1.5s linear; }
.blackout { background:#000 !important; transition:background 2s ease,opacity 1.5s ease; }

#startOverlay, #end {
  font-weight: 800;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  text-shadow: 0 0 14px rgba(255,255,255,0.25);
}

/* Overlay to begin */
#startOverlay {
  position:fixed; inset:0;
  background:#000; color:#fff;
  display:flex; align-items:center; justify-content:center;
  font-size:clamp(24px,5vw,60px);
  z-index:10; cursor:pointer;
  text-align:center;
}
</style>
</head>

<body>
<!-- Tap-to-begin overlay -->
<div id="startOverlay" class="flicker">PRESS ENTER TO START TRANSMISSION</div>

<canvas id="snow"></canvas>

<!-- IMPORTANT: Make sure this filename matches your repo exactly -->
<audio id="beep" src="speech_20251111195406392.mp3" preload="auto"></audio>

<div class="container" id="content">
  <div class="title">North Pole Intelligence Agency – Priority One Alert</div>
  <p class="body">
    Agents, the Christmas Delivery Command has been compromised.<br>
    The Naughty/Nice Algorithm has been infected with rogue code.<br>
    Reindeer launch systems are offline.<br><br>
    Your objective: Restore all systems before midnight.<br>
    Collect clues, decode transmissions, and neutralize the saboteur.<br><br>
    Await further instructions. Christmas depends on you.
  </p>
  <p class="footer small">North Pole Command · NPIA Secure Broadcast</p>
</div>

<div id="end" class="endscreen">TRANSMISSION ENDED</div>

<script src="snow.js"></script>
<script>
(function () {
  console.log("mission0 script loaded");

  // Show "TRANSMISSION ENDED" for this long before redirecting
  const END_SCREEN_MS = 10000;          // 10 seconds

  // Safety fallback in case audio can't play / never ends event
  const FALLBACK_END_MS = 60000;        // 60 seconds

  // Small cinematic timings (doesn't control when the transmission ends)
  const INITIAL_FLICKER_MS = 1500;
  const PRE_BLACKOUT_FLICKER_MS = 900;  // brief flicker right before blackout
  const BLACKOUT_TO_END_MS = 600;       // pause before showing "TRANSMISSION ENDED"

  const audio   = document.getElementById("beep");
  const content = document.getElementById("content");
  const end     = document.getElementById("end");
  const snow    = document.getElementById("snow");
  const overlay = document.getElementById("startOverlay");

  if (!overlay) {
    console.warn("startOverlay not found");
    return;
  }

  let endStarted = false;

  function startEndSequence(reason) {
    if (endStarted) return;
    endStarted = true;
    console.log("starting end sequence:", reason);

    // Flicker the content quickly before blackout
    if (content) content.classList.add("flicker");

    setTimeout(() => {
      // Blackout + hide content + stop snow
      document.body.classList.add("blackout");
      if (content) content.style.opacity = 0;
      if (snow) snow.style.display = "none";

      setTimeout(() => {
        // Show TRANSMISSION ENDED
        if (end) {
          end.style.background = "#000";
          end.style.color = "#fff";
          end.style.opacity = 1;
          end.classList.add("flicker");
        }

        // Redirect after END_SCREEN_MS
        setTimeout(() => {
          console.log("redirecting to mission control stage=0");
          window.location.href = "operation_save_christmas.html?stage=0";
        }, END_SCREEN_MS);

      }, BLACKOUT_TO_END_MS);

    }, PRE_BLACKOUT_FLICKER_MS);
  }

  overlay.addEventListener("click", () => {
    console.log("overlay clicked");

    // Hide overlay so the click "unlocks" audio
    overlay.style.display = "none";

    // Initial flicker for drama
    if (content) {
      content.classList.add("flicker");
      setTimeout(() => content.classList.remove("flicker"), INITIAL_FLICKER_MS);
    }

    // If audio exists, use its natural end to trigger the transition
    if (audio) {
      try { audio.currentTime = 0; } catch (e) {}

      // Trigger end sequence when audio finishes
      audio.addEventListener("ended", () => startEndSequence("audio ended"), { once: true });

      audio.play().then(
        () => console.log("audio playing"),
        (err) => {
          console.warn("audio play blocked or failed", err);
          // If audio can't play, fall back to timer
          setTimeout(() => startEndSequence("fallback (audio blocked)"), FALLBACK_END_MS);
        }
      );

      // Safety fallback even if play succeeds but 'ended' never fires
      setTimeout(() => startEndSequence("fallback (safety)"), FALLBACK_END_MS);

    } else {
      console.warn("audio element not found; using fallback timer");
      setTimeout(() => startEndSequence("fallback (no audio element)"), FALLBACK_END_MS);
    }
  });
})();
</script>
</body>
</html>
